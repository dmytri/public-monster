<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.bunny.net">
<link href="https://fonts.bunny.net/css?family=anton:400|comic-neue:400,700" rel="stylesheet">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåê</text></svg>">
<title>Profile - public.monster</title>
<!-- Privacy-friendly analytics by Plausible -->
<script async src="https://plausible.io/js/pa-neokOJSyQG1cGL1NXRHGs.js"></script>
<script>
  window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
  plausible.init()
</script>
<script type="module">
import { register } from "https://esm.run/@teamhanko/hanko-elements";

const { hanko } = await register("HANKO_API_URL_PLACEHOLDER");

const token = await hanko.getSessionToken();
if (!token) {
  window.location.href = '/';
} else {
  const user = await hanko.getUser();
  document.getElementById('username').textContent = user.username;
  window.originalUsername = user.username; // Store for migration
}

hanko.onSessionExpired(() => {
  window.location.href = '/';
});

hanko.onUserDeleted(() => {
  window.location.href = '/';
});

// Step 1: Prepare migration
window.prepareMigration = async function() {
  const confirmed = confirm('This will prepare your account for username migration. Click OK to continue.');
  if (!confirmed) return;
  
  const token = await hanko.getSessionToken();
  const res = await fetch('/api/prepare-migration', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` }
  });
  
  if (res.ok) {
    const data = await res.json();
    window.migrationToken = data.token;
    alert('‚úì Migration prepared! Now you can change your username in the profile below, then click the second button.');
    document.getElementById('migrate-btn').style.display = 'inline-block';
  } else {
    alert('Failed to prepare migration.');
  }
};

// Step 2: Execute migration
window.migrateUsername = async function() {
  if (!window.migrationToken) {
    alert('You must click "Prepare migration" first!');
    return;
  }
  
  const newUser = await hanko.getUser();
  const newUsername = newUser.username;
  const oldUsername = window.originalUsername;
  
  if (oldUsername === newUsername) {
    alert('Your username has not changed.');
    return;
  }
  
  const confirmed = confirm(`Migrate all files from ~${oldUsername}/ to ~${newUsername}/?\n\nIf this fails, you can change your username back to "${oldUsername}" to recover your files and try again.`);
  if (!confirmed) return;
  
  // Show progress indicator
  const progressDiv = document.createElement('div');
  progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:3px solid #000;padding:30px;font-size:1.2em;z-index:9999';
  progressDiv.textContent = 'Migrating files, please wait...';
  document.body.appendChild(progressDiv);
  
  const token = await hanko.getSessionToken();
  const res = await fetch('/api/migrate-username', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ 
      oldUsername,
      token: window.migrationToken 
    })
  });
  
  document.body.removeChild(progressDiv);
  
  if (res.ok) {
    alert('‚úì Files migrated successfully!');
    delete window.migrationToken;
    window.location.reload();
  } else {
    const error = await res.text();
    alert('Migration failed: ' + error + '\n\nYou can change your username back to "' + oldUsername + '" to recover your files.');
  }
};
</script>
<style>
body{background:#008080;color:#000;font-family:"Comic Neue","Comic Sans MS",cursive;margin:20px}
main{background:#c0c0c0;border:4px outset #fff;padding:20px;max-width:800px;margin:0 auto;position:relative}
h1{color:#ff00ff;font-family:Anton,Impact,"Arial Black",sans-serif;text-shadow:3px 3px 0 #000,5px 5px 10px rgba(0,0,0,0.5);font-size:2.5em;margin:0;letter-spacing:1px}
h2{color:#000;background:#ff0;padding:5px 10px;display:inline-block}
a{color:#00f;text-decoration:underline}
.beta-badge{position:absolute;top:-10px;right:-10px;background:#ff0;color:#f00;font-weight:bold;font-size:1.5em;padding:8px 16px;border:3px solid #f00;transform:rotate(15deg);box-shadow:3px 3px 0 #000;z-index:1000}
#profile-container{background:#fff;border:2px inset #999;padding:15px;margin:20px 0}
@media(max-width:600px){h1{font-size:1.5em}h2{font-size:1.2em}.beta-badge{font-size:1.2em;padding:6px 12px}}
</style>
</head>
<body>
<main role="main">
<div class="beta-badge">BETA</div>
<h1>üåê Profile üåê</h1>
<h2>~<span id="username"></span></h2>
<div style="background:#ff0;border:3px solid #f00;padding:15px;margin:20px 0;font-weight:bold">
‚ö†Ô∏è <strong>WARNING: Changing your username is EXPERIMENTAL</strong><br><br>
<strong>RISKS:</strong><br>
‚Ä¢ Migration may fail and you could lose your data<br>
‚Ä¢ If you get it wrong, your old files may become accessible to whoever registers your old username<br>
‚Ä¢ This is a temporary workaround until we build a proper solution<br><br>
<strong>RECOVERY:</strong> If something goes wrong, change your username back to the original and you can probably recover your files and try again.<br><br>
<strong>PROCESS:</strong><br>
1. Download a backup first (use the üì• icon in File Manager)<br>
2. Click "Prepare migration" below<br>
3. Change your username in the profile<br>
4. Click "Complete migration"<br><br>
<button onclick="prepareMigration()" style="background:#c0c0c0;border:2px outset #fff;padding:5px 15px;cursor:pointer;font-family:inherit;font-size:1em;margin-right:10px">Step 1: Prepare migration</button>
<button id="migrate-btn" onclick="migrateUsername()" style="display:none;background:#c0c0c0;border:2px outset #fff;padding:5px 15px;cursor:pointer;font-family:inherit;font-size:1em">Step 2: Complete migration</button>
</div>
<div id="profile-container">
  <hanko-profile lang="en" translations='{"en":{"profile":{"username":{"title":"Username (cannot be changed)"}}}}'></hanko-profile>
</div>
<p><a href="/">‚Üê Back to Upload</a></p>
<footer style="text-align:center;margin-top:40px;padding-top:20px;border-top:2px groove #999;font-size:0.9em">
by <a href="/~dmytri" rel="noopener">~dmytri</a> &nbsp;|&nbsp; <a href="/about">about</a> &nbsp;|&nbsp; <a href="/faq">faq</a>
</footer>
</main>
</body>
</html>
